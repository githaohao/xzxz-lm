# 对话列表功能说明

## 新增功能概览

本次更新为小智小智聊天系统添加了完整的对话管理功能，让用户能够创建多个对话，每个对话都有独立的文档库和消息历史。

## 核心功能

### 1. 对话管理
- ✅ **创建新对话**: 点击对话列表顶部的"新建"按钮
- ✅ **对话切换**: 点击对话列表中的任意对话进行切换
- ✅ **重命名对话**: 通过下拉菜单重命名对话标题
- ✅ **删除对话**: 删除不需要的对话（会同时删除关联的文档）
- ✅ **清空消息**: 清空对话中的所有消息，保留对话结构

### 2. 智能文档库关联 ⭐ **核心特性**
- ✅ **对话独立文档库**: 每个对话拥有完全独立的RAG文档库
- ✅ **切换对话切换文档**: 点击不同对话会自动切换到该对话的文档库
- ✅ **文档自动关联**: 上传的文档自动且仅关联到当前对话
- ✅ **文档数量显示**: 实时显示每个对话关联的文档数量
- ✅ **智能RAG检索**: RAG检索只在当前对话的文档中进行
- ✅ **文档删除功能**: 可以删除对话中的文档

### 3. 数据持久化
- ✅ **本地缓存**: 对话数据保存在本地localStorage中
- ✅ **自动恢复**: 刷新页面后自动恢复对话状态
- ✅ **数据结构**: 支持未来扩展到数据库存储

## 文档库关联详细说明

### 🔄 对话切换与文档库
- **自动切换**: 当您点击不同的对话时，右侧的文档面板会自动显示该对话关联的文档
- **独立隔离**: 每个对话的文档库完全独立，互不影响
- **状态保持**: 每个对话都会记住其关联的文档，切换回来时自动恢复

### 📁 文档关联方式

#### 直接上传（推荐且唯一方式）
1. 确保您在想要添加文档的对话中
2. 直接拖拽文件到聊天界面或点击附件按钮
3. 文档上传完成后自动且仅关联到当前对话
4. **注意**: 文档只存在于上传时的对话中，不会出现在其他对话

### 📊 文档状态显示
- **顶部工具栏**: 显示当前对话的文档数量
- **对话列表**: 每个对话项显示其关联的文档数量
- **文档面板标题**: 显示当前正在查看的对话名称

### 🗑️ 文档管理
- **删除文档**: 点击文档项的 ✕ 按钮删除文档（彻底删除）
- **批量删除**: 选择多个文档后批量删除
- **注意**: 删除文档是彻底删除，无法恢复

## 技术实现

### 简化的Store架构
```typescript
// 对话管理store
export const useConversationStore = defineStore('conversation', () => {
  // 对话列表
  const conversations = ref<Conversation[]>([])
  // 当前活跃对话
  const currentConversation = ref<Conversation | null>(null)
  // 对话数据（消息+文档）
  const conversationData = ref<Map<string, ConversationData>>(new Map())
})

// 简化的RAG store - 专注于当前对话
export const useRAGStore = defineStore('rag', () => {
  // 当前对话关联的文档
  const currentConversationDocuments = ref<RAGDocument[]>([])
  // 基于当前对话的计算属性
  const documents = computed(() => currentConversationDocuments.value)
})
```

### 数据结构
```typescript
// 对话基本信息
interface Conversation {
  id: string
  title: string
  createdAt: Date
  updatedAt: Date
  messageCount: number
  lastMessage?: string
  isActive?: boolean
}

// 对话完整数据
interface ConversationData {
  conversation: Conversation
  messages: Message[]
  ragDocuments: RAGDocument[]  // 与该对话关联的文档
}
```

## 用户界面

### 1. 对话列表面板
- 位置：聊天界面左侧（可收缩）
- 功能：显示所有对话，支持搜索、新建、管理
- 信息显示：对话标题、最后消息、消息数量、**文档数量**、更新时间

### 2. 文档面板（简化设计）
- **标题显示**: "📚 当前对话文档" + 对话名称
- **文档列表**: 只显示当前对话的文档
- **操作按钮**: 删除文档（彻底删除）
- **空状态提示**: 提示在聊天界面上传文件

### 3. 顶部工具栏
- 显示当前对话标题和消息数量
- **文档关联状态**: 📚 X 个文档（显示当前对话的文档数量）
- 面板切换按钮

## 使用流程

### 创建对话并添加文档
1. 点击左侧对话列表的"新建"按钮创建新对话
2. 在新对话中上传文档（自动且仅关联到此对话）

### 对话间切换和文档查看
1. 在对话列表中点击不同的对话
2. 文档面板会自动切换显示该对话的文档
3. RAG检索只在当前对话的文档中进行

### 文档管理
1. 在文档面板中查看当前对话的所有文档
2. 使用 ✕ 按钮彻底删除不需要的文档

## 数据存储

### 当前版本（本地存储）
```javascript
// localStorage中的数据结构
{
  conversations: Conversation[],
  currentConversationId: string,
  conversationData: {
    id: string,
    data: {
      conversation: Conversation,
      messages: Message[],
      ragDocuments: RAGDocument[]  // 关键：每个对话的文档列表
    }
  }[]
}
```

### 未来扩展（数据库存储）
- 可以轻松迁移到后端数据库
- 支持用户账户系统
- 云端同步功能

## 注意事项

1. **首次使用**: 系统会自动创建一个"默认对话"
2. **文档关联**: 上传的文档仅关联到当前活跃的对话
3. **对话切换**: 切换对话时文档面板会自动更新
4. **文档隔离**: 每个对话的RAG检索完全独立
5. **数据安全**: 对话数据仅保存在本地浏览器中
6. **文档唯一性**: 文档只存在于上传时的对话中

## 快捷键和操作

- `Ctrl + Enter`: 发送消息
- `Shift + Enter`: 换行
- 拖拽文件: 上传文档到当前对话
- 点击对话: 快速切换对话（文档库也会切换）
- 搜索框: 快速找到对话

## 实际使用场景

### 场景1: 项目管理
- 创建"项目A"对话，上传项目相关文档
- 创建"项目B"对话，上传另一个项目文档
- 切换对话时，RAG检索只在对应项目文档中进行

### 场景2: 学习研究
- 创建"机器学习"对话，上传ML相关论文和资料
- 创建"Web开发"对话，上传前端后端相关文档
- 每个主题的讨论都基于相关领域的文档

### 场景3: 工作任务
- 为每个客户创建独立对话，上传该客户的文档
- 切换客户时自动切换相关文档和聊天历史
- 确保信息不会混淆

## 技术优势

1. **真正的对话隔离**: 文档库完全按对话隔离
2. **简洁的管理**: 文档仅属于上传时的对话，无需复杂的关联管理
3. **直观的操作**: 在哪个对话上传，文档就属于哪个对话
4. **响应式设计**: 基于Vue 3的响应式架构
5. **类型安全**: 完整的TypeScript类型定义
6. **状态同步**: 对话切换时自动同步文档状态
7. **扩展性**: 易于扩展到数据库存储

## 设计理念

**简单直观**: 
- 用户在哪个对话上传文档，文档就属于哪个对话
- 不需要复杂的"添加到对话"、"移除关联"等操作
- 每个对话都是完全独立的工作空间

**数据隔离**:
- 不同对话的文档完全隔离
- 避免文档在多个对话间共享造成的混乱
- RAG检索严格限定在当前对话的文档范围内

**用户体验**:
- 符合用户直觉的操作方式
- 减少学习成本
- 降低误操作的可能性 