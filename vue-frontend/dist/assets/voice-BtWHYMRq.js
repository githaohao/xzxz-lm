import{c as Z,I as ee,r as a,a as D,$ as oe,a0 as ae,a1 as ne,a2 as te}from"./index-CSZ9edpw.js";import{g as le,c as ue}from"./index-hijg72sg.js";/**
 * @license lucide-vue-next v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=Z("volume-x",[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["line",{x1:"22",x2:"16",y1:"9",y2:"15",key:"1ewh16"}],["line",{x1:"16",x2:"22",y1:"9",y2:"15",key:"5ykzw1"}]]),ve=ee("voice",()=>{const m=a([]),n=a("idle"),p=a(!1),l=a(!1),y=a(!1),A=a(`voice-chat-${Date.now()}`),T=a(0),F=a(""),c=a(!1),U=a(!1),f=a(null),g=a(null),d=a(null),i=a(null),u=a(null),x=a(30),M=a(2e3),R=a(1e3),S=a(3e4),b=a(0),I=a(0),L=a(!1),q=D(()=>m.value.length>0),H=D(()=>n.value!=="idle"),N=D(()=>c.value&&n.value==="idle");function h(e){const o={...e,id:le(),timestamp:new Date};return m.value.push(o),o}function O(){if(!g.value||!i.value)return;const e=i.value.frequencyBinCount,o=new Uint8Array(e);L.value=!0,b.value=Date.now(),I.value=Date.now();function r(){if(!L.value||!i.value)return;i.value.getByteFrequencyData(o);let v=0;for(let C=0;C<e;C++)v+=o[C];const t=v/e,s=Date.now(),w=s-I.value,j=s-b.value;if(t>x.value&&(b.value=s),j>M.value&&w>R.value||w>S.value){console.log(`ğŸ”‡ æ™ºèƒ½é™éŸ³æ£€æµ‹: å¹³å‡éŸ³é‡=${t.toFixed(1)}, é™éŸ³æ—¶é•¿=${j}ms, å½•éŸ³æ—¶é•¿=${w}ms`),E();return}requestAnimationFrame(r)}r()}function z(){L.value=!1}function E(){u.value&&u.value.state==="recording"&&(u.value.stop(),p.value=!1,z(),console.log("ğŸ¤ å½•éŸ³å·²åœæ­¢"))}async function $(){try{c.value=await oe(),U.value=!!(window.webkitSpeechRecognition||window.SpeechRecognition),console.log("æœåŠ¡çŠ¶æ€æ£€æŸ¥:",{funAudio:c.value,speechRecognition:U.value})}catch(e){console.error("æ£€æŸ¥æœåŠ¡çŠ¶æ€å¤±è´¥:",e),c.value=!1}}async function B(){try{const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});f.value=e,g.value=new AudioContext;const o=g.value.createMediaStreamSource(e);i.value=g.value.createAnalyser(),i.value.fftSize=256,i.value.smoothingTimeConstant=.8,o.connect(i.value),console.log("âœ… å½•éŸ³åˆå§‹åŒ–æˆåŠŸï¼Œæ™ºèƒ½é™éŸ³æ£€æµ‹å·²å¯ç”¨")}catch(e){throw console.error("âŒ å½•éŸ³åˆå§‹åŒ–å¤±è´¥:",e),new Error("æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®")}}async function k(){if(f.value||await B(),!f.value)throw new Error("éŸ³é¢‘æµæœªåˆå§‹åŒ–");try{u.value=new MediaRecorder(f.value,{mimeType:"audio/webm;codecs=opus"});const e=[];u.value.ondataavailable=o=>{o.data.size>0&&e.push(o.data)},u.value.onstop=async()=>{const o=new Blob(e,{type:"audio/webm"});await P("",o)},u.value.start(),p.value=!0,n.value="listening",O(),console.log("ğŸ¤ å¼€å§‹å½•éŸ³ (æ™ºèƒ½é™éŸ³æ£€æµ‹å·²å¯ç”¨)")}catch(e){throw console.error("âŒ å¼€å§‹å½•éŸ³å¤±è´¥:",e),e}}async function P(e,o){if(!e.trim()&&!o)return;n.value="processing";let r=null,v="";try{if(c.value&&o){console.log("ğŸ¯ ä½¿ç”¨FunAudioLLMæµç¨‹");const t=await ae(o,A.value,"auto");if(t.success)r=h({content:t.recognized_text||"[è¯­éŸ³è¾“å…¥]",isUser:!0,recognizedText:t.recognized_text}),v=t.response,T.value=t.history_length||0,console.log("âœ… FunAudioLLMè¯­éŸ³å¯¹è¯æˆåŠŸ");else if((t.error||"").includes("æœªè¯†åˆ«åˆ°æœ‰æ•ˆè¯­éŸ³å†…å®¹")){console.log("ğŸ”‡ æœªæ£€æµ‹åˆ°è¯­éŸ³å†…å®¹ï¼Œè‡ªåŠ¨ç»“æŸé€šè¯"),V();return}else throw new Error(t.error||"FunAudioLLMå¯¹è¯å¤±è´¥")}else throw new Error("æ— æœ‰æ•ˆè¾“å…¥");if(v){const t=h({content:v,isUser:!1});await _(v)}}catch(t){console.error("âŒ å¤„ç†è¯­éŸ³å¤±è´¥:",t),r||(r=h({content:"[è¯­éŸ³è¾“å…¥]",isUser:!0})),h({content:"æŠ±æ­‰ï¼Œå¤„ç†æ‚¨çš„è¯­éŸ³æ—¶å‡ºç°äº†é—®é¢˜ã€‚è¯·ç¨åé‡è¯•ã€‚",isUser:!1})}n.value="connected"}async function _(e){try{const o=ue(e);if(console.log("ğŸ”Š å¼€å§‹è¯­éŸ³åˆæˆ:",o.substring(0,50)+"..."),!o.trim()){console.warn("âš ï¸ æ¸…ç†åçš„æ–‡æœ¬ä¸ºç©ºï¼Œè·³è¿‡è¯­éŸ³åˆæˆ"),l.value=!1,n.value="connected";return}l.value=!0,n.value="speaking";try{const r=await ne({text:o,voice:"zh-CN-XiaoxiaoNeural",rate:.9,pitch:1.1}),v=new Blob([r],{type:"audio/wav"}),t=URL.createObjectURL(v),s=new Audio(t);s.volume=y.value?0:.8,d.value=s,s.onplay=()=>{console.log("âœ… AIè¯­éŸ³æ’­æ”¾å¼€å§‹")},s.onended=()=>{console.log("âœ… AIè¯­éŸ³æ’­æ”¾ç»“æŸ"),l.value=!1,n.value="connected",URL.revokeObjectURL(t),setTimeout(()=>{c.value&&n.value==="connected"&&k()},500)},s.onerror=w=>{console.error("âŒ éŸ³é¢‘æ’­æ”¾é”™è¯¯:",w),l.value=!1,n.value="connected",URL.revokeObjectURL(t)},await s.play()}catch(r){console.error("âŒ TTS APIè°ƒç”¨å¤±è´¥:",r),l.value=!1,n.value="connected"}}catch(o){console.error("âŒ è¯­éŸ³åˆæˆå¤±è´¥:",o),l.value=!1,n.value="connected"}}async function X(){c.value||(console.log("âš ï¸ æ£€æµ‹åˆ°FunAudioLLMæœåŠ¡ä¸å¯ç”¨ï¼Œå°è¯•é‡æ–°æ£€æŸ¥çŠ¶æ€..."),await $(),await new Promise(e=>setTimeout(e,1e3)));try{n.value="connecting",console.log("ğŸ¤ å¯åŠ¨FunAudioLLMå½•éŸ³æ¨¡å¼"),await B(),n.value="connected",setTimeout(()=>{k()},1e3),m.value=[]}catch(e){throw console.error("âŒ å¼€å§‹é€šè¯å¤±è´¥:",e),n.value="idle",new Error("å¼€å§‹é€šè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥éº¦å…‹é£æƒé™å¹¶é‡è¯•")}}function V(){n.value="idle",p.value=!1,l.value=!1,F.value="",z(),u.value&&u.value.state==="recording"&&u.value.stop(),u.value=null,f.value&&(f.value.getTracks().forEach(e=>e.stop()),f.value=null),g.value&&(g.value.close(),g.value=null),i.value=null,d.value&&(d.value.pause(),d.value=null),console.log("ğŸ“ é€šè¯å·²ç»“æŸï¼Œæ‰€æœ‰èµ„æºå·²æ¸…ç†")}function G(){y.value=!y.value,d.value&&(d.value.pause(),l.value=!1)}function J(){l.value&&(d.value&&d.value.pause(),l.value=!1,n.value="connected",c.value&&setTimeout(()=>{k()},500))}async function K(){try{await te(A.value)?(m.value=[],T.value=0,console.log("âœ… å¯¹è¯å†å²å·²æ¸…é™¤")):console.error("âŒ æ¸…é™¤å¯¹è¯å†å²å¤±è´¥")}catch(e){console.error("âŒ æ¸…é™¤å¯¹è¯å†å²é”™è¯¯:",e)}}function Q(){A.value=`voice-chat-${Date.now()}`,m.value=[],T.value=0,console.log("ğŸ”„ ä¼šè¯å·²é‡æ–°å¼€å§‹")}function W(){switch(n.value){case"idle":return"æœªè¿æ¥";case"connecting":return"æ­£åœ¨è¿æ¥...";case"connected":return"å·²è¿æ¥";case"listening":return"æ­£åœ¨å¬æ‚¨è¯´è¯...";case"speaking":return"AIæ­£åœ¨å›å¤...";case"processing":return"æ­£åœ¨å¤„ç†...";default:return"æœªçŸ¥çŠ¶æ€"}}function Y(e){e.threshold!==void 0&&(x.value=Math.max(0,Math.min(255,e.threshold))),e.timeout!==void 0&&(M.value=Math.max(500,e.timeout)),e.minRecordingTime!==void 0&&(R.value=Math.max(500,e.minRecordingTime)),e.maxRecordingTime!==void 0&&(S.value=Math.max(5e3,e.maxRecordingTime)),console.log("ğŸ”§ æ™ºèƒ½é™éŸ³æ£€æµ‹é…ç½®å·²æ›´æ–°:",{threshold:x.value,timeout:M.value,minRecordingTime:R.value,maxRecordingTime:S.value})}return{messages:m,callState:n,isRecording:p,isAIPlaying:l,isMuted:y,sessionId:A,conversationRounds:T,currentTranscript:F,funAudioAvailable:c,speechRecognitionAvailable:U,silenceDetectionActive:L,silenceThreshold:x,silenceTimeout:M,minRecordingTime:R,maxRecordingTime:S,hasMessages:q,isConnected:H,canStartCall:N,addMessage:h,checkServiceStatus:$,startCall:X,endCall:V,startRecording:k,stopRecording:E,toggleMute:G,interruptAI:J,clearHistory:K,restartSession:Q,getStatusText:W,configureSilenceDetection:Y}});export{ie as V,ve as u};
//# sourceMappingURL=voice-BtWHYMRq.js.map
