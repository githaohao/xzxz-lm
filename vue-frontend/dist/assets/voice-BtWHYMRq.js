import{c as Z,I as ee,r as a,a as D,$ as oe,a0 as ae,a1 as ne,a2 as te}from"./index-CSZ9edpw.js";import{g as le,c as ue}from"./index-hijg72sg.js";/**
 * @license lucide-vue-next v0.511.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=Z("volume-x",[["path",{d:"M11 4.702a.705.705 0 0 0-1.203-.498L6.413 7.587A1.4 1.4 0 0 1 5.416 8H3a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h2.416a1.4 1.4 0 0 1 .997.413l3.383 3.384A.705.705 0 0 0 11 19.298z",key:"uqj9uw"}],["line",{x1:"22",x2:"16",y1:"9",y2:"15",key:"1ewh16"}],["line",{x1:"16",x2:"22",y1:"9",y2:"15",key:"5ykzw1"}]]),ve=ee("voice",()=>{const m=a([]),n=a("idle"),p=a(!1),l=a(!1),y=a(!1),A=a(`voice-chat-${Date.now()}`),T=a(0),F=a(""),c=a(!1),U=a(!1),f=a(null),g=a(null),d=a(null),i=a(null),u=a(null),x=a(30),M=a(2e3),R=a(1e3),S=a(3e4),b=a(0),I=a(0),L=a(!1),q=D(()=>m.value.length>0),H=D(()=>n.value!=="idle"),N=D(()=>c.value&&n.value==="idle");function h(e){const o={...e,id:le(),timestamp:new Date};return m.value.push(o),o}function O(){if(!g.value||!i.value)return;const e=i.value.frequencyBinCount,o=new Uint8Array(e);L.value=!0,b.value=Date.now(),I.value=Date.now();function r(){if(!L.value||!i.value)return;i.value.getByteFrequencyData(o);let v=0;for(let C=0;C<e;C++)v+=o[C];const t=v/e,s=Date.now(),w=s-I.value,j=s-b.value;if(t>x.value&&(b.value=s),j>M.value&&w>R.value||w>S.value){console.log(`🔇 智能静音检测: 平均音量=${t.toFixed(1)}, 静音时长=${j}ms, 录音时长=${w}ms`),E();return}requestAnimationFrame(r)}r()}function z(){L.value=!1}function E(){u.value&&u.value.state==="recording"&&(u.value.stop(),p.value=!1,z(),console.log("🎤 录音已停止"))}async function $(){try{c.value=await oe(),U.value=!!(window.webkitSpeechRecognition||window.SpeechRecognition),console.log("服务状态检查:",{funAudio:c.value,speechRecognition:U.value})}catch(e){console.error("检查服务状态失败:",e),c.value=!1}}async function B(){try{const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});f.value=e,g.value=new AudioContext;const o=g.value.createMediaStreamSource(e);i.value=g.value.createAnalyser(),i.value.fftSize=256,i.value.smoothingTimeConstant=.8,o.connect(i.value),console.log("✅ 录音初始化成功，智能静音检测已启用")}catch(e){throw console.error("❌ 录音初始化失败:",e),new Error("无法访问麦克风，请检查权限设置")}}async function k(){if(f.value||await B(),!f.value)throw new Error("音频流未初始化");try{u.value=new MediaRecorder(f.value,{mimeType:"audio/webm;codecs=opus"});const e=[];u.value.ondataavailable=o=>{o.data.size>0&&e.push(o.data)},u.value.onstop=async()=>{const o=new Blob(e,{type:"audio/webm"});await P("",o)},u.value.start(),p.value=!0,n.value="listening",O(),console.log("🎤 开始录音 (智能静音检测已启用)")}catch(e){throw console.error("❌ 开始录音失败:",e),e}}async function P(e,o){if(!e.trim()&&!o)return;n.value="processing";let r=null,v="";try{if(c.value&&o){console.log("🎯 使用FunAudioLLM流程");const t=await ae(o,A.value,"auto");if(t.success)r=h({content:t.recognized_text||"[语音输入]",isUser:!0,recognizedText:t.recognized_text}),v=t.response,T.value=t.history_length||0,console.log("✅ FunAudioLLM语音对话成功");else if((t.error||"").includes("未识别到有效语音内容")){console.log("🔇 未检测到语音内容，自动结束通话"),V();return}else throw new Error(t.error||"FunAudioLLM对话失败")}else throw new Error("无有效输入");if(v){const t=h({content:v,isUser:!1});await _(v)}}catch(t){console.error("❌ 处理语音失败:",t),r||(r=h({content:"[语音输入]",isUser:!0})),h({content:"抱歉，处理您的语音时出现了问题。请稍后重试。",isUser:!1})}n.value="connected"}async function _(e){try{const o=ue(e);if(console.log("🔊 开始语音合成:",o.substring(0,50)+"..."),!o.trim()){console.warn("⚠️ 清理后的文本为空，跳过语音合成"),l.value=!1,n.value="connected";return}l.value=!0,n.value="speaking";try{const r=await ne({text:o,voice:"zh-CN-XiaoxiaoNeural",rate:.9,pitch:1.1}),v=new Blob([r],{type:"audio/wav"}),t=URL.createObjectURL(v),s=new Audio(t);s.volume=y.value?0:.8,d.value=s,s.onplay=()=>{console.log("✅ AI语音播放开始")},s.onended=()=>{console.log("✅ AI语音播放结束"),l.value=!1,n.value="connected",URL.revokeObjectURL(t),setTimeout(()=>{c.value&&n.value==="connected"&&k()},500)},s.onerror=w=>{console.error("❌ 音频播放错误:",w),l.value=!1,n.value="connected",URL.revokeObjectURL(t)},await s.play()}catch(r){console.error("❌ TTS API调用失败:",r),l.value=!1,n.value="connected"}}catch(o){console.error("❌ 语音合成失败:",o),l.value=!1,n.value="connected"}}async function X(){c.value||(console.log("⚠️ 检测到FunAudioLLM服务不可用，尝试重新检查状态..."),await $(),await new Promise(e=>setTimeout(e,1e3)));try{n.value="connecting",console.log("🎤 启动FunAudioLLM录音模式"),await B(),n.value="connected",setTimeout(()=>{k()},1e3),m.value=[]}catch(e){throw console.error("❌ 开始通话失败:",e),n.value="idle",new Error("开始通话失败，请检查麦克风权限并重试")}}function V(){n.value="idle",p.value=!1,l.value=!1,F.value="",z(),u.value&&u.value.state==="recording"&&u.value.stop(),u.value=null,f.value&&(f.value.getTracks().forEach(e=>e.stop()),f.value=null),g.value&&(g.value.close(),g.value=null),i.value=null,d.value&&(d.value.pause(),d.value=null),console.log("📞 通话已结束，所有资源已清理")}function G(){y.value=!y.value,d.value&&(d.value.pause(),l.value=!1)}function J(){l.value&&(d.value&&d.value.pause(),l.value=!1,n.value="connected",c.value&&setTimeout(()=>{k()},500))}async function K(){try{await te(A.value)?(m.value=[],T.value=0,console.log("✅ 对话历史已清除")):console.error("❌ 清除对话历史失败")}catch(e){console.error("❌ 清除对话历史错误:",e)}}function Q(){A.value=`voice-chat-${Date.now()}`,m.value=[],T.value=0,console.log("🔄 会话已重新开始")}function W(){switch(n.value){case"idle":return"未连接";case"connecting":return"正在连接...";case"connected":return"已连接";case"listening":return"正在听您说话...";case"speaking":return"AI正在回复...";case"processing":return"正在处理...";default:return"未知状态"}}function Y(e){e.threshold!==void 0&&(x.value=Math.max(0,Math.min(255,e.threshold))),e.timeout!==void 0&&(M.value=Math.max(500,e.timeout)),e.minRecordingTime!==void 0&&(R.value=Math.max(500,e.minRecordingTime)),e.maxRecordingTime!==void 0&&(S.value=Math.max(5e3,e.maxRecordingTime)),console.log("🔧 智能静音检测配置已更新:",{threshold:x.value,timeout:M.value,minRecordingTime:R.value,maxRecordingTime:S.value})}return{messages:m,callState:n,isRecording:p,isAIPlaying:l,isMuted:y,sessionId:A,conversationRounds:T,currentTranscript:F,funAudioAvailable:c,speechRecognitionAvailable:U,silenceDetectionActive:L,silenceThreshold:x,silenceTimeout:M,minRecordingTime:R,maxRecordingTime:S,hasMessages:q,isConnected:H,canStartCall:N,addMessage:h,checkServiceStatus:$,startCall:X,endCall:V,startRecording:k,stopRecording:E,toggleMute:G,interruptAI:J,clearHistory:K,restartSession:Q,getStatusText:W,configureSilenceDetection:Y}});export{ie as V,ve as u};
//# sourceMappingURL=voice-BtWHYMRq.js.map
