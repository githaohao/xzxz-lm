<template>
  <div class="flex h-full bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-800">
    <!-- RAGÊñáÊ°£ÁÆ°ÁêÜÈù¢Êùø -->
    <div 
      :class="[
        'transition-all duration-300 ease-in-out flex-shrink-0',
        showDocumentPanel ? 'w-80' : 'w-0'
      ]"
    >
      <RAGDocumentPanel v-show="showDocumentPanel" />
    </div>

    <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
    <div class="flex-1 flex flex-col">
      <!-- È°∂ÈÉ®Â∑•ÂÖ∑Ê†è -->
      <div class="flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm">
        <div class="flex items-center gap-3">
          <button
            @click="toggleDocumentPanel"
            class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
            :title="showDocumentPanel ? 'ÈöêËóèÊñáÊ°£Èù¢Êùø' : 'ÊòæÁ§∫ÊñáÊ°£Èù¢Êùø'"
          >
            <PanelLeftOpen v-if="!showDocumentPanel" class="h-5 w-5 text-slate-600 dark:text-slate-400" />
            <PanelLeftClose v-else class="h-5 w-5 text-slate-600 dark:text-slate-400" />
          </button>
          <h1 class="text-lg font-semibold text-slate-900 dark:text-slate-100">Êô∫ËÉΩÂØπËØù</h1>
        </div>
        
        <div class="flex items-center gap-2">
          <Badge v-if="selectedDocumentCount > 0" variant="outline" class="text-purple-600 border-purple-300">
            üìö Â∑≤ÈÄâ {{ selectedDocumentCount }} ‰∏™ÊñáÊ°£
          </Badge>
        </div>
      </div>

      <div class="flex-1 container mx-auto px-4 py-4 max-w-7xl flex flex-col min-h-0">
        <!-- Êñá‰ª∂Â§ÑÁêÜÁä∂ÊÄÅ -->
        <div v-if="processedFile" class="flex-shrink-0 mb-4">
          <div class="relative max-w-7xl mx-auto px-2">
            <div class="
              flex items-center gap-4 p-3
              bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-950/50 dark:to-indigo-950/50
              border border-blue-200/50 dark:border-blue-800/50
              rounded-xl shadow-lg backdrop-blur-sm
              transition-all duration-300
            ">
              <!-- Êñá‰ª∂ÂõæÊ†á -->
              <div class="flex-shrink-0">
                <div class="w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-900/50 flex items-center justify-center shadow-sm">
                  <Paperclip class="h-5 w-5 text-blue-600 dark:text-blue-400" />
                </div>
              </div>
              
              <!-- Êñá‰ª∂‰ø°ÊÅØ -->
              <div class="flex-1 min-w-0">
                <p class="font-semibold text-sm text-slate-900 dark:text-slate-100 truncate">{{ processedFile.name }}</p>
                <p class="text-xs text-slate-600 dark:text-slate-400">{{ formatFileSize(processedFile.size) }}</p>
                <div class="flex items-center gap-2 mt-1">
                  <div v-if="processedFile.processing" class="w-1.5 h-1.5 rounded-full bg-yellow-500 animate-pulse"></div>
                  <div v-else class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></div>
                  <span v-if="processedFile.processing" class="text-xs text-yellow-600 dark:text-yellow-400 font-medium">Â§ÑÁêÜ‰∏≠...</span>
                  <span v-else class="text-xs text-green-600 dark:text-green-400 font-medium">Â∑≤ÂáÜÂ§áÂ∞±Áª™</span>
                </div>
                
                <!-- RAGÁä∂ÊÄÅÊòæÁ§∫ -->
                <div v-if="processedFile.rag_enabled" class="flex items-center gap-2 mt-1">
                  <div class="w-1.5 h-1.5 rounded-full bg-purple-500"></div>
                  <span class="text-xs text-purple-600 dark:text-purple-400 font-medium">
                    üß† Êô∫ËÉΩÊ£ÄÁ¥¢Â∑≤ÂêØÁî®
                  </span>
                  <Badge variant="secondary" class="text-xs px-1.5 py-0.5">
                    RAG
                  </Badge>
                </div>
                <div v-else-if="processedFile.ocrCompleted && processedFile.content" class="flex items-center gap-2 mt-1">
                  <div class="w-1.5 h-1.5 rounded-full bg-gray-400"></div>
                  <span class="text-xs text-gray-500 dark:text-gray-400 font-medium">
                    üìÑ Â∏∏ËßÑÊñáÊú¨Ê®°Âºè
                  </span>
                </div>
              </div>
              
              <!-- ÁßªÈô§ÊåâÈíÆ -->
              <button
                @click="setProcessedFile(null)"
                class="
                  flex-shrink-0 p-1.5 rounded-lg
                  hover:bg-red-50 dark:hover:bg-red-900/20
                  text-slate-500 hover:text-red-600 dark:text-slate-400 dark:hover:text-red-400
                  transition-all duration-200
                  focus:outline-none focus:ring-2 focus:ring-red-500/20
                "
              >
                <X class="h-4 w-4" />
              </button>
            </div>
          </div>
        </div>

        <!-- Ê∂àÊÅØÂàóË°® -->
        <ScrollArea 
          ref="scrollAreaRef"
          class="flex-1 min-h-0 pr-2" 
          style="height: calc(100vh - 280px);"
        >
          <div class="space-y-4 pb-4">
            <!-- ÂéÜÂè≤Ê∂àÊÅØ -->
            <div
              v-for="message in messages"
              :key="message.id"
              :class="[
                'flex gap-3 max-w-full',
                message.isUser ? 'flex-row-reverse' : ''
              ]"
            >
              <!-- Â§¥ÂÉè -->
              <Avatar class="w-8 h-8 flex-shrink-0 mt-1">
                <AvatarFallback 
                  :class="[
                    'text-white font-medium text-sm',
                    message.isUser 
                      ? 'bg-gradient-to-br from-green-500 to-emerald-600' 
                      : 'bg-gradient-to-br from-blue-500 to-purple-600'
                  ]"
                >
                  <User v-if="message.isUser" class="h-4 w-4" />
                  <Bot v-else class="h-4 w-4" />
                </AvatarFallback>
              </Avatar>

              <div :class="['flex flex-col gap-2 max-w-[80%]', message.isUser ? 'items-end' : 'items-start']">
                <!-- Êñá‰ª∂‰ø°ÊÅØ -->
                <Card v-if="message.fileInfo" class="border-slate-200 dark:border-slate-700">
                  <CardContent class="p-2">
                    <div class="flex items-center gap-2 text-xs">
                      <Paperclip class="h-3 w-3 text-slate-500" />
                      <span class="text-slate-700 dark:text-slate-300 truncate max-w-40">{{ message.fileInfo.name }}</span>
                      <Badge variant="secondary" class="text-xs px-1 py-0">
                        {{ formatFileSize(message.fileInfo.size) }}
                      </Badge>
                      <!-- RAGÊåáÁ§∫Âô® -->
                      <Badge v-if="message.fileInfo.rag_enabled" variant="outline" class="text-xs text-purple-600 border-purple-300 px-1 py-0">
                        üß† RAG
                      </Badge>
                    </div>
                  </CardContent>
                </Card>

                <!-- Ê∂àÊÅØÂÜÖÂÆπ -->
                <Card 
                  :class="[
                    'shadow-sm transition-all duration-200 hover:shadow-md max-w-full',
                    message.isUser 
                      ? 'bg-gradient-to-br from-green-500 to-emerald-600 text-white border-green-200' 
                      : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700'
                  ]"
                >
                  <CardContent class="p-3">
                    <div v-if="!message.isUser && hasThinkTags(message.content)" class="space-y-2">
                      <!-- ÊÄùËÄÉÂÜÖÂÆπÔºàÂèØÊäòÂè†Ôºâ -->
                      <details class="group">
                        <summary class="cursor-pointer text-xs text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 flex items-center gap-1">
                          <span class="text-sm">ü§î</span>
                          <span>ÊÄùËÄÉËøáÁ®ã</span>
                          <span class="text-xs opacity-60 group-open:hidden">(Â±ïÂºÄ)</span>
                        </summary>
                        <div class="mt-2 p-2 bg-slate-50 dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-700">
                          <div class="text-xs text-slate-600 dark:text-slate-300 whitespace-pre-wrap leading-relaxed max-h-32 overflow-y-auto">
                            {{ extractThinkContent(message.content).think }}
                          </div>
                        </div>
                      </details>
                      
                      <Separator class="my-2" />
                      
                      <!-- ÂÆûÈôÖÂõûÂ§çÂÜÖÂÆπ -->
                      <div class="text-sm text-slate-800 dark:text-slate-200 whitespace-pre-wrap leading-relaxed">
                        {{ extractThinkContent(message.content).content }}
                      </div>
                    </div>
                    <div v-else class="text-sm whitespace-pre-wrap leading-relaxed break-words">
                      {{ message.content }}
                    </div>
                  </CardContent>
                </Card>

                <!-- Êó∂Èó¥Êà≥ -->
                <div class="text-xs text-slate-400 dark:text-slate-500 px-1">
                  {{ formatTime(message.timestamp) }}
                </div>
              </div>
            </div>

          <!-- ÂΩìÂâçÊµÅÂºèÊ∂àÊÅØ -->
          <div
            v-if="currentStreamingMessage"
            class="flex gap-3 max-w-full"
          >
            <Avatar class="w-8 h-8 flex-shrink-0 mt-1">
              <AvatarFallback class="bg-gradient-to-br from-blue-500 to-purple-600 text-white text-sm">
                <Bot class="h-4 w-4" />
              </AvatarFallback>
            </Avatar>

            <div class="flex flex-col gap-2 max-w-[80%] items-start">
              <Card class="bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 shadow-sm max-w-full">
                <CardContent class="p-3">
                  <div v-if="hasThinkTags(currentStreamingMessage.content)" class="space-y-2">
                    <!-- ÊÄùËÄÉÂÜÖÂÆπÔºàÂèØÊäòÂè†Ôºâ -->
                    <details class="group" :open="currentStreamingMessage.isStreaming && !extractThinkContent(currentStreamingMessage.content).content">
                      <summary class="cursor-pointer text-xs text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 flex items-center gap-1">
                        <span class="text-sm">ü§î</span>
                        <span>Êü•ÁúãÊÄùËÄÉËøáÁ®ã</span>
                        <span class="text-xs opacity-60 group-open:hidden">(Â±ïÂºÄ)</span>
                      </summary>
                      <div class="mt-2 p-2 bg-slate-50 dark:bg-slate-900 rounded-lg border border-slate-200 dark:border-slate-700">
                        <div class="text-xs text-slate-600 dark:text-slate-300 whitespace-pre-wrap leading-relaxed max-h-32 overflow-y-auto">
                          {{ extractThinkContent(currentStreamingMessage.content).think }}
                          <span v-if="currentStreamingMessage.isStreaming && !extractThinkContent(currentStreamingMessage.content).content" class="inline-block w-1.5 h-4 bg-blue-500 animate-pulse ml-1">‚ñã</span>
                        </div>
                      </div>
                    </details>
                    
                    <Separator v-if="extractThinkContent(currentStreamingMessage.content).content" class="my-2" />
                    
                    <!-- ÂÆûÈôÖÂõûÂ§çÂÜÖÂÆπ -->
                    <div v-if="extractThinkContent(currentStreamingMessage.content).content" class="text-sm text-slate-800 dark:text-slate-200 whitespace-pre-wrap leading-relaxed">
                      {{ extractThinkContent(currentStreamingMessage.content).content }}
                      <span v-if="currentStreamingMessage.isStreaming" class="inline-block w-1.5 h-4 bg-blue-500 animate-pulse ml-1">‚ñã</span>
                    </div>
                  </div>
                  <div v-else class="text-sm text-slate-800 dark:text-slate-200 whitespace-pre-wrap leading-relaxed break-words">
                    {{ currentStreamingMessage.content }}
                    <span v-if="currentStreamingMessage.isStreaming" class="inline-block w-1.5 h-4 bg-blue-500 animate-pulse ml-1">‚ñã</span>
                  </div>
                </CardContent>
              </Card>
            </div>
          </div>
          
          <!-- ÊªöÂä®Áä∂ÊÄÅÊåáÁ§∫Âô® -->
          <div 
            v-if="!isAtBottom && messages.length > 0"
            class="flex justify-center py-2"
          >
            <button
              @click="scrollToBottom"
              class="
                flex items-center gap-2 px-3 py-1.5 
                bg-blue-500/90 hover:bg-blue-600/90 
                text-white text-xs rounded-full 
                shadow-lg backdrop-blur-sm
                transition-all duration-200 hover:scale-105
                animate-pulse
              "
            >
              <span>‚Üì</span>
              <span>ÊªöÂä®Âà∞Â∫ïÈÉ®</span>
            </button>
          </div>
        </div>
      </ScrollArea>

      <!-- ËæìÂÖ•Âå∫Âüü -->
      <div class="flex-shrink-0 mt-4 px-2">
        <!-- RAGÊô∫ËÉΩÂª∫ËÆÆ -->
        <div v-if="ragSuggestion" class="max-w-7xl mx-auto mb-2">
          <div class="flex items-center gap-2 p-2 bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-950/30 dark:to-blue-950/30 border border-purple-200 dark:border-purple-800 rounded-lg">
            <div class="text-purple-600 dark:text-purple-400">üí°</div>
            <span class="text-xs text-purple-700 dark:text-purple-300">{{ ragSuggestion }}</span>
            <button 
              v-if="!ragEnabled"
              @click="ragEnabled = true"
              class="ml-auto text-xs bg-purple-100 hover:bg-purple-200 dark:bg-purple-900 dark:hover:bg-purple-800 text-purple-700 dark:text-purple-300 px-2 py-1 rounded-md transition-colors"
            >
              ÂêØÁî®RAG
            </button>
          </div>
        </div>
        
        <!-- GrokÈ£éÊ†ºÁöÑÁé∞‰ª£ÂåñËæìÂÖ•Ê°Ü -->
        <div class="relative max-w-7xl mx-auto">
          <!-- ‰∏ªËæìÂÖ•ÂÆπÂô® -->
          <div 
            :class="[
              'relative flex items-end gap-3 p-4 transition-all duration-300 ease-out',
              'bg-white/90 dark:bg-slate-800/90 backdrop-blur-xl',
              'border rounded-3xl shadow-2xl shadow-black/5 dark:shadow-black/20',
              'hover:shadow-2xl hover:shadow-black/10 dark:hover:shadow-black/30',
              'focus-within:ring-2 focus-within:ring-blue-500/20 focus-within:border-blue-500/30',
              isDragging 
                ? 'border-blue-500 bg-blue-50/80 dark:bg-blue-950/80 scale-[1.02] shadow-2xl shadow-blue-500/20' 
                : 'border-slate-200/50 dark:border-slate-700/50'
            ]"
            @drop.prevent="handleFileDrop"
            @dragover.prevent="handleDragOver"
            @dragenter.prevent="handleDragEnter"
            @dragleave.prevent="handleDragLeave"
          >
            <!-- Êñá‰ª∂ÈôÑ‰ª∂ÂõæÊ†á -->
            <div class="flex-shrink-0 pb-1">
              <button
                @click="fileInput?.click()"
                :disabled="isLoading"
                class="
                  group relative p-2 rounded-lg
                  bg-slate-50 dark:bg-slate-700/50
                  hover:bg-slate-100 dark:hover:bg-slate-600/50
                  border border-slate-200 dark:border-slate-600
                  transition-all duration-200 ease-out
                  hover:scale-105 hover:shadow-lg
                  disabled:opacity-50 disabled:cursor-not-allowed
                  focus:outline-none focus:ring-2 focus:ring-blue-500/20
                "
              >
                <Paperclip class="h-4 w-4 text-slate-600 dark:text-slate-300 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors" />
                
                <!-- ÊÇ¨ÊµÆÊèêÁ§∫ -->
                <div class="
                  absolute -top-8 left-1/2 transform -translate-x-1/2
                  px-2 py-1 text-xs text-white bg-slate-900 rounded-md
                  opacity-0 group-hover:opacity-100 transition-opacity duration-200
                  pointer-events-none whitespace-nowrap
                ">
                  Ê∑ªÂä†Êñá‰ª∂
                </div>
              </button>
              
              <input
                ref="fileInput"
                type="file"
                accept=".pdf,.png,.jpg,.jpeg,.wav,.mp3"
                @change="handleFileSelect"
                class="hidden"
              />
            </div>

            <!-- ËæìÂÖ•Ê°ÜÂå∫Âüü -->
            <div class="flex-1 relative">
              <Textarea
                v-model="inputMessage"
                placeholder="ËæìÂÖ•‰Ω†ÁöÑÊ∂àÊÅØ..."
                class="
                  w-full min-h-[44px] max-h-32 py-3 px-4
                  bg-transparent border-0 resize-none
                  text-slate-900 dark:text-slate-100
                  placeholder:text-slate-500 dark:placeholder:text-slate-400
                  focus:outline-none focus:ring-0
                  text-sm leading-relaxed
                  scrollbar-thin scrollbar-thumb-slate-300 dark:scrollbar-thumb-slate-600
                "
                :disabled="isLoading"
                @keydown.enter.exact.prevent="handleSend"
                @keydown.enter.shift.exact.prevent="inputMessage += '\n'"
              />
              
              <!-- Â≠óÁ¨¶ËÆ°Êï∞ÔºàÂèØÈÄâÔºâ -->
              <div 
                v-if="inputMessage.length > 800"
                class="absolute bottom-1 right-2 text-xs text-slate-400 dark:text-slate-500"
              >
                {{ inputMessage.length }}/2000
              </div>
            </div>

            <!-- ÂèëÈÄÅÊåâÈíÆÂå∫Âüü -->
            <div class="flex-shrink-0 pb-1">
              <Button
                v-if="isLoading"
                @click="cancelRequest"
                size="lg"
                class="
                  h-9 w-9 p-0 rounded-lg
                  bg-red-500 hover:bg-red-600
                  border-0 shadow-lg hover:shadow-xl
                  transition-all duration-200 ease-out
                  hover:scale-105
                "
              >
                <X class="h-4 w-4 text-white" />
              </Button>
              
              <Button
                v-else
                @click="handleSend"
                :disabled="(!inputMessage.trim() && !processedFile) || isLoading"
                size="lg"
                class="
                  h-9 w-9 p-0 rounded-lg
                  bg-gradient-to-r from-blue-600 to-purple-600 
                  hover:from-blue-700 hover:to-purple-700
                  disabled:from-slate-300 disabled:to-slate-400
                  border-0 shadow-lg hover:shadow-xl
                  transition-all duration-200 ease-out
                  hover:scale-105 disabled:hover:scale-100
                  focus:outline-none focus:ring-2 focus:ring-blue-500/20
                "
              >
                <Send class="h-4 w-4 text-white ml-0.5" />
              </Button>
            </div>
          </div>

          <!-- ËæìÂÖ•ÊèêÁ§∫ -->
          <div class="flex items-center justify-between mt-2 px-4 text-xs text-slate-500 dark:text-slate-400">
            <div class="flex items-center gap-3">
              <span class="flex items-center gap-1">
                <kbd class="px-1 py-0.5 bg-slate-100 dark:bg-slate-700 rounded text-[10px] font-mono">‚èé</kbd>
                ÂèëÈÄÅ
              </span>
              <span class="flex items-center gap-1">
                <kbd class="px-1 py-0.5 bg-slate-100 dark:bg-slate-700 rounded text-[10px] font-mono">‚áß</kbd>
                <kbd class="px-1 py-0.5 bg-slate-100 dark:bg-slate-700 rounded text-[10px] font-mono">‚èé</kbd>
                Êç¢Ë°å
              </span>
              
              <!-- RAGÊ®°ÂºèÂàáÊç¢ -->
              <div v-if="processedFile?.rag_enabled" class="flex items-center gap-1 ml-2">
                <input 
                  id="rag-toggle"
                  v-model="ragEnabled"
                  type="checkbox" 
                  class="w-3 h-3 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500 dark:focus:ring-purple-600 dark:ring-offset-gray-800 focus:ring-1 dark:bg-gray-700 dark:border-gray-600"
                />
                <label for="rag-toggle" class="text-xs text-purple-600 dark:text-purple-400 font-medium cursor-pointer">
                  üß† Êô∫ËÉΩÊ£ÄÁ¥¢
                </label>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <span>ÊîØÊåÅ PDF„ÄÅÂõæÁâáÊãñÊãΩ‰∏ä‰º†</span>
            </div>
          </div>

          <!-- Âä†ËΩΩÁä∂ÊÄÅÊåáÁ§∫Âô® -->
          <div 
            v-if="isLoading"
            class="absolute -top-1 left-1/2 transform -translate-x-1/2"
          >
            <div class="flex items-center gap-2 px-3 py-1.5 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-full text-sm shadow-lg">
              <div class="w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
              <span>{{ processingStatus || 'AIÊ≠£Âú®ÊÄùËÄÉ...' }}</span>
            </div>
          </div>
        </div>
      </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, watch, nextTick, onMounted, onUnmounted } from 'vue'
import { storeToRefs } from 'pinia'
import { 
  Send, 
  Paperclip, 
  Bot, 
  User, 
  Loader2,
  X,
  PanelLeftOpen,
  PanelLeftClose
} from 'lucide-vue-next'
import { Card, CardContent } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { Textarea } from '@/components/ui/textarea'
import { ScrollArea } from '@/components/ui/scroll-area'
import { Separator } from '@/components/ui/separator'
import { Avatar, AvatarFallback } from '@/components/ui/avatar'
import { useChatStore } from '@/stores/chat'
import { useRAGStore } from '@/stores/rag'
import { formatTime, formatFileSize, hasThinkTags, extractThinkContent } from '@/utils'
import { uploadFile } from '@/utils/api'
import { getRagSuggestion, isFileRagSuitable } from '@/utils/rag-utils'
import RAGDocumentPanel from '@/components/RAGDocumentPanel.vue'

const chatStore = useChatStore()
const {
  messages,
  isLoading,
  processingStatus,
  currentStreamingMessage,
  processedFile
} = storeToRefs(chatStore)

const { sendMessage, cancelRequest, setProcessedFile } = chatStore

const inputMessage = ref('')
const fileInput = ref<HTMLInputElement>()
const isDragging = ref(false)
const ragEnabled = ref(true) // ÈªòËÆ§ÂêØÁî®RAG
const showDocumentPanel = ref(true) // ÊòæÁ§∫ÊñáÊ°£Èù¢Êùø

// RAG Store
const ragStore = useRAGStore()
const { selectedCount: selectedDocumentCount } = storeToRefs(ragStore)

// Êñ∞Â¢ûÔºöÊªöÂä®Âå∫ÂüüÂºïÁî®
const scrollAreaRef = ref<InstanceType<typeof ScrollArea>>()

// Êñ∞Â¢ûÔºöÊô∫ËÉΩÊªöÂä®ÊéßÂà∂
const isUserScrolling = ref(false)
const scrollTimeout = ref<number | null>(null)
const isAtBottom = ref(true)

// ÂàáÊç¢ÊñáÊ°£Èù¢ÊùøÊòæÁ§∫
function toggleDocumentPanel() {
  showDocumentPanel.value = !showDocumentPanel.value
}

// ËÆ°ÁÆóÊô∫ËÉΩÂª∫ËÆÆ
const ragSuggestion = computed(() => {
  if (!processedFile.value?.content || !inputMessage.value) return null
  return getRagSuggestion(inputMessage.value, processedFile.value.content)
})

// Êñ∞Â¢ûÔºöÊ£ÄÊµãÊòØÂê¶Âú®Â∫ïÈÉ®ÁöÑÂáΩÊï∞
function checkIfAtBottom(viewport: Element) {
  const threshold = 50 // ÂÖÅËÆ∏50pxÁöÑËØØÂ∑Æ
  const isBottom = viewport.scrollTop + viewport.clientHeight >= viewport.scrollHeight - threshold
  isAtBottom.value = isBottom
  return isBottom
}

// Êñ∞Â¢ûÔºöÂ§ÑÁêÜÁî®Êà∑ÊªöÂä®‰∫ã‰ª∂
function handleUserScroll(event: Event) {
  const viewport = event.target as Element
  
  // Ê£ÄÊµãÊòØÂê¶Âú®Â∫ïÈÉ®
  checkIfAtBottom(viewport)
  
  // Ê†áËÆ∞Áî®Êà∑Ê≠£Âú®ÊªöÂä®
  isUserScrolling.value = true
  
  // Ê∏ÖÈô§‰πãÂâçÁöÑË∂ÖÊó∂
  if (scrollTimeout.value) {
    clearTimeout(scrollTimeout.value)
  }
  
  // 1ÁßíÂêéÈáçÁΩÆÁî®Êà∑ÊªöÂä®Áä∂ÊÄÅ
  scrollTimeout.value = setTimeout(() => {
    isUserScrolling.value = false
    // Â¶ÇÊûúÂú®Â∫ïÈÉ®ÔºåÈáçÊñ∞ÂêØÁî®Ëá™Âä®ÊªöÂä®
    if (isAtBottom.value) {
      scrollToBottom()
    }
  }, 1000)
}

// Êñ∞Â¢ûÔºöËá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®ÂáΩÊï∞
function scrollToBottom() {
  // Â¶ÇÊûúÁî®Êà∑Ê≠£Âú®ÊªöÂä®Ôºå‰∏çÊâßË°åËá™Âä®ÊªöÂä®
  if (isUserScrolling.value) return
  
  nextTick(() => {
    if (scrollAreaRef.value) {
      const viewport = scrollAreaRef.value.$el.querySelector('[data-reka-scroll-area-viewport]')
      if (viewport) {
        viewport.scrollTop = viewport.scrollHeight
        isAtBottom.value = true
      }
    }
  })
}

// Êñ∞Â¢ûÔºöÂàùÂßãÂåñÊªöÂä®ÁõëÂê¨
function initScrollListener() {
  nextTick(() => {
    if (scrollAreaRef.value) {
      const viewport = scrollAreaRef.value.$el.querySelector('[data-reka-scroll-area-viewport]')
      if (viewport) {
        viewport.addEventListener('scroll', handleUserScroll, { passive: true })
      }
    }
  })
}

// Êñ∞Â¢ûÔºöÊ∏ÖÁêÜÊªöÂä®ÁõëÂê¨
function cleanupScrollListener() {
  if (scrollAreaRef.value) {
    const viewport = scrollAreaRef.value.$el.querySelector('[data-reka-scroll-area-viewport]')
    if (viewport) {
      viewport.removeEventListener('scroll', handleUserScroll)
    }
  }
  if (scrollTimeout.value) {
    clearTimeout(scrollTimeout.value)
  }
}

// ÁîüÂëΩÂë®ÊúüÈí©Â≠ê
onMounted(() => {
  initScrollListener()
})

onUnmounted(() => {
  cleanupScrollListener()
})

// ÁõëÂê¨Ê∂àÊÅØÂèòÂåñÔºåÊô∫ËÉΩËá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
watch(
  () => messages.value.length,
  () => {
    // Âè™ÊúâÂú®Â∫ïÈÉ®ÊàñËÄÖ‰∏çÊòØÁî®Êà∑ÊªöÂä®Êó∂ÊâçËá™Âä®ÊªöÂä®
    if (isAtBottom.value || !isUserScrolling.value) {
      scrollToBottom()
    }
  }
)

// ÁõëÂê¨ÊµÅÂºèÊ∂àÊÅØÂÜÖÂÆπÂèòÂåñÔºåÊô∫ËÉΩËá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®  
watch(
  () => currentStreamingMessage.value?.content,
  () => {
    if (currentStreamingMessage.value && (isAtBottom.value || !isUserScrolling.value)) {
      scrollToBottom()
    }
  }
)

// ÂèëÈÄÅÊ∂àÊÅØ
async function handleSend() {
  if (!inputMessage.value.trim() && !processedFile.value && selectedDocumentCount.value === 0) return

  // ‰ºòÂÖà‰ΩøÁî®ÈÄâ‰∏≠ÁöÑÊñáÊ°£
  let fileToSend = processedFile.value
  
  // Â¶ÇÊûúÊúâÈÄâ‰∏≠ÁöÑÊñáÊ°£Ôºå‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÈÄâ‰∏≠ÁöÑÊñáÊ°£ÔºàÊàñËÄÖÂèØ‰ª•Êâ©Â±ï‰∏∫Â§öÊñáÊ°£ÊîØÊåÅÔºâ
  if (selectedDocumentCount.value > 0) {
    const selectedDocs = ragStore.selectedDocumentsList
    if (selectedDocs.length > 0) {
      const firstDoc = selectedDocs[0]
              fileToSend = {
          name: firstDoc.filename,
          type: firstDoc.file_type,
          size: firstDoc.total_length,
          content: '', // ÂÜÖÂÆπ‰ºöÂú®ÂêéÁ´ØÊ£ÄÁ¥¢Êó∂Ëé∑Âèñ
          doc_id: firstDoc.doc_id,
          ocrCompleted: true,
          rag_enabled: ragEnabled.value
        }
    }
  }
  
  // Â¶ÇÊûúÁî®Êà∑ÂÖ≥Èó≠‰∫ÜRAGÔºåÂàõÂª∫‰∏Ä‰∏™‰∏çÂ∏¶RAGÂäüËÉΩÁöÑÊñá‰ª∂ÂâØÊú¨
  if (fileToSend && !ragEnabled.value) {
    fileToSend = {
      ...fileToSend,
      rag_enabled: false,
      doc_id: undefined
    }
  }

  await sendMessage(inputMessage.value, fileToSend || undefined)
  inputMessage.value = ''
}

// Â§ÑÁêÜÊñá‰ª∂ÈÄâÊã©
async function handleFileSelect(event: Event) {
  const target = event.target as HTMLInputElement
  const file = target.files?.[0]
  if (file) {
    await processFile(file)
    target.value = ''
  }
}

// Â§ÑÁêÜÊñá‰ª∂ÊãñÊãΩ
async function handleFileDrop(event: DragEvent) {
  isDragging.value = false
  const file = event.dataTransfer?.files[0]
  if (file) {
    await processFile(file)
  }
}

// ÊãñÊãΩ‰∫ã‰ª∂Â§ÑÁêÜ
function handleDragEnter(event: DragEvent) {
  event.preventDefault()
  isDragging.value = true
}

function handleDragLeave(event: DragEvent) {
  event.preventDefault()
  if (!event.relatedTarget || !(event.currentTarget as Element).contains(event.relatedTarget as Node)) {
    isDragging.value = false
  }
}

function handleDragOver(event: DragEvent) {
  event.preventDefault()
}

// Â§ÑÁêÜÊñá‰ª∂
async function processFile(file: File) {
  try {
    console.log('üìé ÂºÄÂßãÂ§ÑÁêÜÊñá‰ª∂:', file.name)
    
    // ËÆæÁΩÆÂ§ÑÁêÜ‰∏≠Áä∂ÊÄÅ
    setProcessedFile({
      name: file.name,
      size: file.size,
      type: file.type,
      processing: true
    })

    // ‰∏ä‰º†Âπ∂Â§ÑÁêÜÊñá‰ª∂
    const result = await uploadFile(file)
    
    // ËÆæÁΩÆÊñá‰ª∂Áä∂ÊÄÅÔºàuploadFileÂáΩÊï∞Â∑≤ÁªèÂ§ÑÁêÜ‰∫ÜocrCompletedÂíåprocessingÁä∂ÊÄÅÔºâ
    setProcessedFile(result)
    
    if (result.ocrCompleted) {
      console.log('‚úÖ OCRÂ§ÑÁêÜÂÆåÊàêÔºåÊñá‰ª∂Â∑≤ÂáÜÂ§áÂ∞±Áª™ÔºàÊîØÊåÅRAGÊô∫ËÉΩÊ£ÄÁ¥¢Ôºâ:', result)
    } else {
      console.log('‚è≥ Êñá‰ª∂‰∏ä‰º†ÊàêÂäüÔºåOCRÂ§ÑÁêÜ‰∏≠:', result)
    }
  } catch (error: any) {
    console.error('‚ùå Êñá‰ª∂Â§ÑÁêÜÂ§±Ë¥•:', error)
    setProcessedFile(null)
    alert(`Êñá‰ª∂Â§ÑÁêÜÂ§±Ë¥•: ${error.message}`)
  }
}
</script>