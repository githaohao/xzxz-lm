# LLM文档分析功能使用指南

## 🎯 功能概述

小智小智知识库系统现已集成真正的LLM（大语言模型）文档分析功能，能够智能分析文档内容并自动决定最合适的知识库归档位置。该功能特别针对不同大小的文档采用了智能处理策略，既保证分析准确性又优化处理速度。

## 🚀 核心特性

### 1. 真正的AI分析
- **智能内容理解**：基于LM Studio的大语言模型，深度理解文档语义
- **上下文分析**：综合考虑文档标题、内容、用户提示等多维信息
- **类型识别**：准确识别文档类型和适用的知识库分类

### 2. 分层处理策略
根据文档大小自动选择最优的处理策略：

| 文档大小 | 处理策略 | 说明 |
|---------|----------|------|
| < 5,000字符 | 直接全文分析 | 小文档直接提交给LLM分析 |
| 5,000-20,000字符 | 关键段落提取 | 提取开头、结尾、关键段落进行分析 |
| 20,000-100,000字符 | 分段摘要分析 | 将文档分段，生成摘要后分析 |
| > 100,000字符 | 智能采样 | 采样关键部分，提取结构化信息 |

### 3. 缓存优化
- **结果缓存**：相同内容的分析结果会被缓存，避免重复计算
- **快速响应**：缓存命中时响应速度提升5-10倍
- **智能清理**：自动管理缓存大小，保持系统性能

## 📚 预设知识库

系统预设了8个标准知识库，AI会优先匹配这些分类：

1. **个人简历** - 简历、CV、个人资料、求职相关
2. **合同文档** - 合同、协议、法律文件
3. **教育培训** - 培训材料、课程、教育内容
4. **技术文档** - API文档、技术规范、开发资料
5. **商务文档** - 商业计划、市场分析、商务资料
6. **操作手册** - 用户手册、操作指南、说明书
7. **医疗健康** - 医疗报告、健康资料、医学文献
8. **政策法规** - 政策文件、法规条例、规章制度

如果文档不适合任何预设知识库，AI会建议创建新的知识库。

## 🔧 技术实现

### 核心方法：_analyze_document_content

```python
async def _analyze_document_content(
    self, 
    content: str,           # 文档内容
    filename: str,          # 文件名
    analysis_prompt: str,   # 用户分析提示
    custom_analysis: bool   # 是否自定义分析
) -> Dict:                  # 返回分析结果
```

### 处理流程

1. **缓存检查**：首先检查是否有缓存的分析结果
2. **策略选择**：根据文档大小选择处理策略
3. **内容预处理**：根据策略提取或压缩文档内容
4. **LLM分析**：调用大语言模型进行智能分析
5. **结果验证**：验证和修正分析结果
6. **缓存存储**：将结果存储到缓存中

## 📊 各种处理策略详解

### 1. 直接全文分析 (< 5,000字符)
适用于小文档，直接将完整内容提交给LLM分析。

**特点**：
- 最高准确性
- 快速处理
- 适合简历、短报告等

### 2. 关键段落提取 (5,000-20,000字符)
提取文档的关键部分进行分析，包括：
- 文档开头（前20%或最多500行）
- 文档结尾（后10%或最多200行）
- 包含关键词的段落（摘要、总结、概述等）

**特点**：
- 保持高准确性
- 大幅减少处理时间
- 适合中型报告、文档

### 3. 分段摘要分析 (20,000-100,000字符)
将大文档分成多个段落，选择关键段落生成摘要：
- 总是包含开头和结尾段落
- 优先选择包含重要关键词的段落
- 随机补充其他段落以确保代表性

**特点**：
- 平衡准确性和效率
- 适合长篇报告、手册
- 智能段落选择

### 4. 智能采样 (> 100,000字符)
对特大文档采用智能采样策略：
- 开头2000字符
- 结尾1000字符
- 中间按间隔采样（最多10个片段）
- 提取结构化信息（标题、目录等）

**特点**：
- 快速处理超大文档
- 保留关键结构信息
- 适合大型规范、法规文件

## 🎯 LLM提示词设计

### 系统提示词
```
你是一个专业的文档分析专家，负责分析文档内容并决定最合适的知识库归档位置。

你的任务是：
1. 分析文档的主要内容和类型
2. 从预设知识库中选择最合适的归档位置
3. 如果不适合任何预设知识库，建议创建新的知识库

请返回JSON格式的分析结果：
{
    "knowledge_base_name": "知识库名称",
    "is_new_knowledge_base": false,
    "document_type": "文档类型", 
    "reason": "选择理由",
    "confidence": 0.85
}
```

### 用户提示词包含
- 文件名信息
- 用户提供的分析提示
- 处理策略说明
- 实际文档内容（经过预处理）

## 💡 使用最佳实践

### 1. 文件命名
为文件起一个有意义的名称，有助于AI分析：
- ✅ `项文豪个人简历.pdf`
- ✅ `微服务架构技术文档.md`
- ❌ `文档1.pdf`
- ❌ `untitled.doc`

### 2. 分析提示
提供清晰的分析提示，帮助AI理解文档用途：
- ✅ `这是一份个人简历文档`
- ✅ `技术架构设计文档`
- ✅ `公司管理制度文件`

### 3. 内容结构
保持文档良好的结构有助于AI分析：
- 明确的标题和章节
- 清晰的内容组织
- 适当的关键词使用

## 🔍 错误处理和回退机制

### 多层回退策略
1. **主要方式**：LLM智能分析
2. **第一回退**：关键词匹配分析
3. **最终回退**：默认归档到"通用文档"

### 结果验证
- 检查必要字段完整性
- 验证知识库名称有效性
- 修正相似但不完全匹配的名称
- 确保结果格式正确

## 📈 性能特性

### 处理速度
- **小文档**：通常2-5秒完成分析
- **中等文档**：3-8秒完成分析
- **大文档**：5-15秒完成分析
- **特大文档**：8-20秒完成分析

### 缓存优化
- **缓存命中**：毫秒级响应
- **缓存大小**：最多100个结果
- **智能清理**：自动移除最旧的缓存项

### 准确性
- **预设分类**：准确率通常达到85-95%
- **新建知识库**：能合理建议新分类
- **错误恢复**：具备完整的回退机制

## 🧪 测试和验证

### 运行测试脚本
```bash
python test_llm_document_analysis.py
```

### 测试内容
- 不同大小文档的处理策略验证
- LLM分析结果准确性测试
- 缓存功能性能测试
- 错误处理回退机制测试

### 期望结果
- 所有测试用例通过分析
- 分析结果符合预期分类
- 缓存功能正常工作
- 性能指标达到要求

## 🔧 配置和定制

### LM Studio配置
确保LM Studio服务正常运行：
```yaml
lm_studio_base_url: "http://127.0.0.1:1234/v1"
lm_studio_model: "deepseek-r1-0528-qwen3-8b-mlx@8bit"
lm_studio_api_key: "not-needed"
```

### 自定义知识库
可以修改预设知识库列表：
```python
preset_knowledge_bases = {
    "个人简历", "合同文档", "教育培训", "技术文档", 
    "商务文档", "操作手册", "医疗健康", "政策法规",
    # 添加自定义知识库
    "财务报表", "人事档案"
}
```

### 调整处理阈值
可以根据需要调整文档大小阈值：
```python
# 在_analyze_document_content方法中
if content_length < 5000:          # 小文档阈值
elif content_length < 20000:       # 中等文档阈值  
elif content_length < 100000:      # 大文档阈值
else:                              # 特大文档
```

## 🚀 API使用示例

### 智能归档API
```python
# 一步到位归档（保留兼容性）
result = await rag_service.smart_archive_document(
    file_content=file_bytes,
    filename="项目文档.pdf",
    file_type="application/pdf",
    analysis_prompt="技术文档",
    custom_analysis=False
)

# 两阶段归档（推荐）
# 第一阶段：分析预览
analysis = await rag_service.analyze_document_for_archive(
    file_content=file_bytes,
    filename="项目文档.pdf", 
    file_type="application/pdf",
    analysis_prompt="技术文档",
    custom_analysis=False
)

# 第二阶段：确认归档
if user_confirms(analysis):
    result = await rag_service.confirm_archive_document(
        file_content=file_content,
        filename="项目文档.pdf",
        file_type="application/pdf", 
        analysis_result=analysis
    )
```

## 📞 支持和反馈

如果您在使用过程中遇到问题或有改进建议，请：

1. **查看日志**：检查系统日志中的详细错误信息
2. **运行测试**：使用测试脚本验证功能状态
3. **检查配置**：确认LM Studio服务和配置正确
4. **反馈问题**：记录具体的错误现象和复现步骤

系统会持续优化分析准确性和处理性能，为您提供更好的智能文档管理体验！ 