# RAG (Retrieval-Augmented Generation) 功能说明

## 概述

RAG技术已成功集成到小智小智多模态聊天系统中，可以智能处理长文档，提供更精准的回答。

## 🌟 功能特性

### 1. 智能文档处理
- **自动分块**：将长文档分成1000字符的语义块，支持中文标点符号分割
- **向量化存储**：使用sentence-transformers模型将文档转换为向量
- **去重处理**：相同文档只处理一次，避免重复索引

### 2. 语义检索
- **相关性检索**：根据用户问题检索最相关的文档片段
- **相似度阈值**：可设置最小相似度（默认0.6），过滤不相关内容
- **Top-K检索**：返回最相关的K个文档片段（默认5个）

### 3. 成本优化
- **精准上下文**：只将相关文档片段提供给大模型
- **Token节省**：大幅减少不必要的文本处理
- **响应速度**：避免处理长文档的全部内容

## 🚀 技术架构

### 核心组件
- **ChromaDB**：向量数据库，存储文档向量
- **sentence-transformers**：文本嵌入模型
- **LangChain**：文档分割工具
- **RAGService**：核心RAG服务类

### 数据流程
```
文档上传 → OCR处理 → 文档分块 → 向量化 → 存储到ChromaDB
用户提问 → 向量检索 → 获取相关片段 → 构建上下文 → LM生成回答
```

## 📱 使用方法

### 1. 安装RAG依赖
```bash
# 运行安装脚本
bash scripts/install_rag.sh
```

### 2. 启动服务
```bash
# 启动后端
cd backend
python -m app.main

# 启动前端
cd vue-frontend  
pnpm dev
```

### 3. 上传文档
- 支持PDF、PNG、JPG、JPEG格式
- 文件会自动进行OCR文本提取
- 系统会显示"支持RAG智能检索"提示

### 4. 智能对话
- 上传文档后直接提问
- 系统会自动检索相关文档片段
- 显示检索状态和相关片段数量

## 🔧 API接口

### 文档检索
```typescript
POST /api/rag/search
{
  "query": "搜索查询",
  "doc_ids": ["文档ID列表"],
  "top_k": 5,
  "min_similarity": 0.6
}
```

### 文档管理
```typescript
GET /api/rag/documents/{doc_id}     // 获取文档信息
DELETE /api/rag/documents/{doc_id}  // 删除文档
```

## ⚙️ 配置选项

### 文档分块配置
```python
chunk_size=1000         # 每块字符数
chunk_overlap=200       # 重叠字符数
separators=["\n\n", "\n", "。", "！", "？", "；", " ", ""]
```

### 检索配置
```python
top_k=5                 # 返回片段数
min_similarity=0.6      # 最小相似度
embedding_model='sentence-transformers/all-MiniLM-L6-v2'
```

## 🎯 使用场景

### 1. 长文档问答
- **场景**：上传长篇PDF报告，询问特定问题
- **优势**：只检索相关段落，避免token浪费

### 2. 多文档对比
- **场景**：上传多个文档，进行横向对比分析
- **优势**：跨文档智能检索，综合分析

### 3. 技术文档查询
- **场景**：上传技术手册，快速查找解决方案
- **优势**：精准定位相关信息，快速获得答案

## 🔍 状态提示

系统会显示RAG处理状态：
- `正在对文档进行智能索引...` - 文档向量化中
- `文档索引完成: filename` - 索引创建完成
- `正在检索相关文档片段...` - 语义检索中
- `检索到 N 个相关片段` - 检索完成
- `未找到相关片段，使用完整文档` - 回退到原始方式

## 📊 性能优化

### Apple Silicon优化
- 启用MPS加速：`PYTORCH_ENABLE_MPS_FALLBACK=1`
- 内存优化：`MPS_MEMORY_FRACTION=0.8`

### 存储优化
- 向量数据库路径：`uploads/chroma_db`
- 自动去重：相同文档内容不重复索引
- 异步处理：文档向量化使用线程池

## 🛠️ 故障排除

### 常见问题
1. **ChromaDB连接失败**
   - 检查写入权限：`uploads/chroma_db`目录
   - 重新运行安装脚本

2. **向量化失败**
   - 检查网络连接（下载模型）
   - 确认Apple Silicon配置

3. **检索无结果**
   - 调低相似度阈值（min_similarity）
   - 检查文档内容是否正确提取

### 日志查看
```bash
# 查看后端日志
tail -f backend/logs/app.log

# 查看前端控制台
# 打开浏览器开发者工具
```

## 🔮 未来规划

### 短期计划
- [ ] 支持更多文档格式（Word、TXT等）
- [ ] 混合检索（关键词+语义）
- [ ] 文档管理界面

### 长期计划
- [ ] 多语言支持
- [ ] 自定义嵌入模型
- [ ] 集群部署支持

## 💡 最佳实践

1. **文档准备**：确保文档内容清晰，避免扫描版PDF
2. **问题描述**：提问时描述清楚具体需求
3. **批量上传**：一次性上传相关文档，提高检索效果
4. **参数调整**：根据文档类型调整相似度阈值

---

有任何问题欢迎反馈！🚀
